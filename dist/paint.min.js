let ErrorKind={CanvasNotFoundError:"CanvasNotFoundError",ElementIdNotFoundError:"ElementIdNotFoundError",ParentElementNotFoundError:"ParentElementNotFoundError",NotImplementedError:"NotImplementedError"};class AppError extends Error{constructor(t,e){super(`${e}: ${t}`),this.kind=t}static new(t,e="Unknown error"){return new AppError(t,e)}}function createElement(t,e){var i;let s=window.document.querySelector(t),r=window.document.createElement(e.tagName);if(!s)throw AppError.new(ErrorKind.ParentElementNotFoundError);return Object.assign(r.style,e.style),(null===(i=null==e?void 0:e.innerProps)||void 0===i?void 0:i.classList)&&e.innerProps.classList.length>0&&e.innerProps.classList.forEach(t=>r.classList.add(t)),e.innerProps&&Object.keys(e.innerProps).forEach(t=>{"classList"!==t&&r.setAttribute(t,e.innerProps[t])}),s.appendChild(r),r}class Tool{constructor(t){this.name=t}resize({}){throw AppError.new(ErrorKind.NotImplementedError,`Please set resize method in your tool: "${this.name}"`)}}class ColorTool extends Tool{constructor(t){super("ColorTool"),this.props=t,this.currentColor="#00",this.props.setAttribute("id","color-container")}static new(t){return new ColorTool(t)}haldleOnClick(t){return e=>{this.currentColor=t}}resize({width:t,height:e,top:i,left:s,overlayRect:r}){let o=this.props;o.style.width=r.width*t+"px",o.style.height=r.height*e+"px",o.style.top=r.top+r.height*i+"px",o.style.left=r.left+r.width*s+"px"}addColor(t){var e;let i=createElement(`#${this.props.id}`,t),s=null===(e=t.style)||void 0===e?void 0:e.background;s&&i.addEventListener("click",this.haldleOnClick(s))}}let getCursorElement=t=>({tagName:"img",innerProps:{src:t},style:{zIndex:"10",width:"10%"}});class DrawableCanvas extends Tool{constructor(t){var e;super("DrawableCanvas"),this.props=t,this.insertedImageAngle=0,this.isRotating=!1,this.isPainting=!1,this.isSaved=!0,this.lastX=0,this.lastY=0,this.mode="draw",this.ctx=null,this.newCanvasCtxs=[],this.cursor=null,this.cursorImage=null,this.insertedImage=null,this.imageX=0,this.imageY=0,this.ctx=t.getContext("2d"),this.props.style.cursor="none",this.cursor=window.document.querySelector(".cursor"),!this.cursor&&(this.cursor=createElement("#root",{tagName:"div",innerProps:{classList:["cursor"]},style:{width:"5%",zIndex:"10"}}),this.cursorImage&&(null===(e=this.cursor)||void 0===e||e.appendChild(createElement("img",getCursorElement(this.cursorImage)))))}static new(t){return new DrawableCanvas(t)}resize({width:t,height:e,top:i,left:s,overlayRect:r}){let o=this.props,n=this.ctx?this.ctx.getImageData(0,0,o.width,o.height):null,l=r.top+r.height*i,a=r.left+r.width*s,h=document.createElement("canvas"),d=h.getContext("2d");if(d&&this.ctx){if(h.width=o.width,h.height=o.height,d.drawImage(this.props,0,0),o.id="drawable-canvas",o.width=r.width*t,o.height=r.height*e,o.style.top=l+"px",o.style.left=a+"px",!this.isSaved){let c=window.document.querySelectorAll(".image-canvas");return c.forEach(t=>{t.remove()}),window.alert("Changes you made may not be saved.")}n&&(this.ctx.clearRect(0,0,o.width,o.height),this.ctx.putImageData(n,0,0))}}draw(t,e){if(this.ctx){let i=[this.ctx,...this.newCanvasCtxs];i.forEach(i=>{var s;if(i.beginPath(),"eraser"===this.mode)i.globalCompositeOperation="destination-out",i.arc(t,e,(null!==(s=i.lineWidth)&&void 0!==s?s:1)/2,0,2*Math.PI),i.fill();else{if("insert"===this.mode)return;i.globalCompositeOperation="source-over",i.moveTo(this.lastX,this.lastY),i.lineTo(t,e),i.stroke()}[this.lastX,this.lastY]=[t,e]})}}setupNewCanvasForImage(){let t=createElement(".container",{tagName:"canvas",innerProps:{id:`image-canvas-${this.newCanvasCtxs.length}`,classList:["image-canvas"],width:this.props.width,height:this.props.height},style:{position:"absolute",left:this.props.style.left,top:this.props.style.top,zIndex:"10",pointerEvents:"none"}}),e=t.getContext("2d");if(!e||!this.ctx)throw AppError.new(ErrorKind.CanvasNotFoundError,"Could not get context from image canvas");return e.fillStyle=this.ctx.fillStyle,e.strokeStyle=this.ctx.strokeStyle,e.lineWidth=this.ctx.lineWidth,this.newCanvasCtxs.push(e),e}handleConfirmImage(){var t,e,i,s,r,o;if(!this.insertedImage)throw AppError.new(ErrorKind.ElementIdNotFoundError,"insertedImage not found.");let n=this.insertedImageAngle,l=this.imageX-20+(null!==(e=null===(t=this.ctx)||void 0===t?void 0:t.lineWidth)&&void 0!==e?e:1)/2,a=this.imageY-(null!==(s=null===(i=this.ctx)||void 0===i?void 0:i.lineWidth)&&void 0!==s?s:1)/2,h=this.setupNewCanvasForImage();h&&this.ctx&&(h.translate(l,a),h.rotate(n*Math.PI/180),h.translate(-l,-a),h.drawImage(this.insertedImage,this.imageX-20,this.imageY-(null!==(r=this.ctx.lineWidth)&&void 0!==r?r:2),this.ctx.lineWidth,this.ctx.lineWidth),h.setTransform(1,0,0,1,0,0),h.globalCompositeOperation="source-in",h.fillStyle=this.ctx.strokeStyle,h.fillRect(this.imageX-20,this.imageY-(null!==(o=this.ctx.lineWidth)&&void 0!==o?o:2),this.ctx.lineWidth,this.ctx.lineWidth),h.globalCompositeOperation="source-over",this.insertedImage=null)}createConfirmLayer(){var t,e;if(!this.insertedImage)throw AppError.new(ErrorKind.ElementIdNotFoundError,"insertedImage not found.");let i=window.document.querySelector(".cursor");if(!i)throw AppError.new(ErrorKind.ElementIdNotFoundError,"Cursor not found");let s=i.getBoundingClientRect(),r=window.scrollX||document.documentElement.scrollLeft,o=window.scrollY||document.documentElement.scrollTop,n=createElement(".container",{tagName:"div",innerProps:{id:"insert-image-container"},style:{position:"absolute",top:s.top+o+"px",left:s.left+r+"px",width:(null===(t=this.ctx)||void 0===t?void 0:t.lineWidth)+"px",height:(null===(e=this.ctx)||void 0===e?void 0:e.lineWidth)+"px",border:"2px solid #ccc",zIndex:"20",cursor:"pointer"}});createElement(`#${n.id}`,{tagName:"img",innerProps:{src:this.insertedImage.src},style:{position:"absolute",width:"100%",pointerEvents:"none"}});let l=createElement(`#${n.id}`,{tagName:"div",innerProps:{id:"image-rotate-button"},style:{position:"absolute",top:"-35%",left:"40%",width:"30%",height:"30%",background:"yellow"}}),a=createElement(`#${n.id}`,{tagName:"div",innerProps:{id:"image-confirm-button"},style:{position:"absolute",top:"40%",left:"100%",width:"30%",height:"30%",background:"green"}}),h=createElement(`#${n.id}`,{tagName:"div",innerProps:{id:"image-cancel-button"},style:{position:"absolute",top:"70%",left:"100%",width:"30%",height:"30%",background:"red"}});a.addEventListener("click",t=>{this.handleConfirmImage(),n.remove()}),h.addEventListener("click",t=>{n.remove(),this.insertedImage=null}),l.addEventListener("mousedown",()=>this.isRotating=!this.isRotating),l.addEventListener("mouseup",()=>this.isRotating=!1),n.addEventListener("mousemove",t=>{if(!this.isRotating)return;let e=n.getBoundingClientRect(),i=e.left+e.width/2,s=e.top+e.height/2,r=t.clientX-i,o=t.clientY-s,l=Math.atan2(o,r)*(180/Math.PI)+80;n.style.transform=`rotate(${l}deg)`,this.insertedImageAngle=l})}handleImageInsert(t,e){if(this.ctx&&!this.insertedImage){this.insertedImageAngle=0;let i=new Image;i.src="assets/shoes.png",i.onload=()=>{this.insertedImage=i,this.imageX=t,this.imageY=e,this.createConfirmLayer()}}}handleMouseDown(t){let{offsetX:e,offsetY:i}=t;this.isPainting=!0,this.isSaved=!1,this.lastX=e,this.lastY=i,"insert"===this.mode&&this.handleImageInsert(e,i)}handleMouseMove(t){var e,i,s,r,o;if(null===(e=this.cursor)||void 0===e||e.setAttribute("style","top: "+(t.pageY-(null!==(s=null===(i=this.ctx)||void 0===i?void 0:i.lineWidth)&&void 0!==s?s:1))+"px; left: "+(t.pageX-20)+`px; position: absolute; width: ${(null!==(o=null===(r=this.ctx)||void 0===r?void 0:r.lineWidth)&&void 0!==o?o:1)*10}px; z-index: 10; pointer-events: none`),!this.isPainting)return;let{offsetX:n,offsetY:l}=t;this.draw(n,l)}checkCanvasIsEmpty(t){let e=!0;for(let i=0;i<t.length;i+=4)if(0!==t[i+3]){e=!1;break}return e}handleMouseUp(t){if(this.isPainting=!1,this.ctx){let e=this.newCanvasCtxs;e.forEach((t,e)=>{let i=t.getImageData(0,0,this.props.width,this.props.height),s=i.data;if(this.checkCanvasIsEmpty(s)){let r=window.document.querySelector(`#image-canvas-${e}`);null==r||r.remove()}})}}handleMouseOut(t){this.isPainting=!1}addCursor(t){var e,i;for(this.cursorImage=t;null===(e=this.cursor)||void 0===e?void 0:e.firstChild;)this.cursor.removeChild(this.cursor.firstChild);null===(i=this.cursor)||void 0===i||i.appendChild(createElement("img",getCursorElement(this.cursorImage)))}}class DrawingItemTool extends Tool{constructor(t){super("DrawingItemTool"),this.props=t,this.currentItem="round",this.cursorUrl="assets/brush.png",this.props.setAttribute("id","tool-container")}static new(t){return new DrawingItemTool(t)}haldleOnClick(t,e,i){return s=>{this.props.childNodes.forEach(t=>{t.id===e?t.style.opacity=".5":t.style.opacity="1"}),this.currentItem=t,this.cursorUrl=i}}resize({width:t,height:e,top:i,left:s,overlayRect:r}){let o=this.props;o.style.width=r.width*t+"px",o.style.height=r.height*e+"px",o.style.top=r.top+r.height*i+"px",o.style.left=r.left+r.width*s+"px"}addItem(t,e){var i;if(!(null===(i=e.innerProps)||void 0===i?void 0:i.id))throw AppError.new(ErrorKind.ElementIdNotFoundError,"tool item must have id");let s=createElement(`#${this.props.id}`,e),r=createElement(`#${e.innerProps.id}`,{tagName:"img",innerProps:{src:t},style:{padding:"10%",width:"80%",height:"80%"}});s.appendChild(r);let o=e.innerProps["data-line-cap"];s.addEventListener("click",this.haldleOnClick(o,s.id,t))}}let offsetSize=15;class SizingTool extends Tool{constructor(t){super("SizingTool"),this.props=t,this.currentSize=0,this.isFirstSizeAdded=!1,this.props.setAttribute("id","size-container")}static new(t){return new SizingTool(t)}haldleOnClick(t){return e=>{try{let i=parseInt(t,10);this.currentSize=15*i,this.props.childNodes.forEach(t=>{let e=`size-indicator-slider-${this.currentSize/15}`,i=t.childNodes.item(1);i.id===e?i.style.display="block":i.style.display="none"})}catch(s){console.log("size must number: "+s.message)}}}resize({width:t,height:e,top:i,left:s,overlayRect:r}){let o=this.props;o.style.width=r.width*t+"px",o.style.height=r.height*e+"px",o.style.top=r.top+r.height*i+"px",o.style.left=r.left+r.width*s+"px"}addSize(t){var e,i;if(!(null===(e=t.innerProps)||void 0===e?void 0:e["data-size"]))throw AppError.new(ErrorKind.ElementIdNotFoundError,"Please set data attribute for size item");let s=createElement(`#${this.props.id}`,{tagName:"div",innerProps:{id:`size-item-${t.innerProps["data-size"]}`},style:{position:"absolute",display:"flex",flexDirection:"column",justifyContent:"space-between",left:null===(i=t.style)||void 0===i?void 0:i.left,height:"100%"}}),r=createElement(`#${s.id}`,{tagName:"div",innerProps:{id:`size-item-indicator-container-${t.innerProps["data-size"]}`},style:{...t.style,width:"none",background:"none",border:"none",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}}),o=createElement(`#${r.id}`,{tagName:"div",innerProps:{id:`size-item-indicator-${t.innerProps["data-size"]}`},style:{width:`${t.innerProps["data-size"]}px`,height:`${t.innerProps["data-size"]}px`,borderRadius:"50%",background:"black"}}),n=createElement(`#${s.id}`,{...t,innerProps:{id:`size-indicator-slider-${t.innerProps["data-size"]}`},style:{...t.style,display:"none",width:"16px",height:"16px",borderRadius:"50%"}}),l=t.innerProps["data-size"];this.isFirstSizeAdded||this.loadFirstSize(l),l&&(n.addEventListener("click",this.haldleOnClick(l)),o.addEventListener("click",this.haldleOnClick(l)))}loadFirstSize(t){try{let e=parseInt(t,10);this.currentSize=15*e,this.props.childNodes.item(0).childNodes.item(1).style.display="block"}catch(i){console.error(i)}}}class Paint{constructor(t,e){this.backgroundOverlay=e,this.tools=t,this.tools.canvas.props.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.tools.canvas.props.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.tools.canvas.props.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.tools.canvas.props.addEventListener("mouseout",this.handleMouseOut.bind(this)),setTimeout(()=>this.resize(),100),window.addEventListener("resize",this.resize.bind(this))}resize(){let t=this.backgroundOverlay.getBoundingClientRect();this.tools.canvas.resize({width:.75,height:.7,top:.235,left:.016,overlayRect:t}),this.tools.colors.resize({width:.17,height:.38,top:.06,left:.8,overlayRect:t}),this.tools.items.resize({width:.17,height:.29,top:.49,left:.8,overlayRect:t}),this.tools.sizing.resize({width:.17,height:.06,top:.88,left:.8,overlayRect:t})}static new(t,e){return new Paint(t,e)}handleMouseDown(t){this.tools.canvas.handleMouseDown(t)}handleMouseMove(t){if(this.tools.canvas.ctx){switch(this.tools.canvas.addCursor(this.tools.items.cursorUrl),this.tools.canvas.ctx.strokeStyle=this.tools.colors.currentColor,this.tools.items.currentItem){case"eraser":this.tools.canvas.mode="eraser";break;case"insert":this.tools.canvas.mode="insert";break;default:this.tools.canvas.mode="draw"}"eraser"!==this.tools.items.currentItem&&"insert"!==this.tools.items.currentItem&&(this.tools.canvas.ctx.lineCap=this.tools.items.currentItem),this.tools.canvas.ctx.lineWidth=this.tools.sizing.currentSize}this.tools.canvas.handleMouseMove(t)}handleMouseUp(t){this.tools.canvas.handleMouseUp(t)}handleMouseOut(t){this.tools.canvas.handleMouseOut(t)}}export{ColorTool,DrawableCanvas,DrawingItemTool,Paint,SizingTool,createElement};